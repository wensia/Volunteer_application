<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©æ´¥ä¸­è€ƒä½æ¬¡æŸ¥è¯¢ç³»ç»Ÿ</title>
    <!-- æœ¬åœ°é™æ€èµ„æº -->
    <link rel="stylesheet" href="static/css/app.css">
    <script src="static/js/react.production.min.js"></script>
    <script src="static/js/react-dom.production.min.js"></script>
    <script src="static/js/babel-standalone.min.js"></script>
    <script src="static/js/axios.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        
        // é…ç½®
        const CONFIG = {
            API_BASE_URL: '',
            MIN_SCORE: 0,
            MAX_SCORE: 800,
            SCORE_PRECISION: 0.01,  // æ”¯æŒä¸¤ä½å°æ•°
            DEBOUNCE_DELAY: 300,
            CACHE_TTL: 5 * 60 * 1000, // 5åˆ†é’Ÿ
        };
        
        // å·¥å…·å‡½æ•°
        const utils = {
            // éªŒè¯åˆ†æ•°
            validateScore: (score) => {
                const num = parseFloat(score);
                if (isNaN(num)) return { valid: false, error: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—' };
                if (num < CONFIG.MIN_SCORE || num > CONFIG.MAX_SCORE) {
                    return { valid: false, error: `åˆ†æ•°å¿…é¡»åœ¨${CONFIG.MIN_SCORE}-${CONFIG.MAX_SCORE}ä¹‹é—´` };
                }
                // éªŒè¯å°æ•°ä½æ•°ï¼ˆä¿®å¤æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼‰
                const scoreStr = score.toString();
                const decimalIndex = scoreStr.indexOf('.');
                if (decimalIndex !== -1 && scoreStr.length - decimalIndex - 1 > 2) {
                    return { valid: false, error: `åˆ†æ•°ä»…æ”¯æŒä¿ç•™ä¸¤ä½å°æ•°ï¼ˆå¦‚750.25ã€750.50ï¼‰` };
                }
                return { valid: true, value: num };
            },
            
            // æ ¼å¼åŒ–æ•°å­—
            formatNumber: (num) => {
                return new Intl.NumberFormat('zh-CN').format(num);
            },
            
            // é˜²æŠ–å‡½æ•°
            debounce: (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func(...args), delay);
                };
            },
            
            // è·å–åˆ†æ•°æ®µå»ºè®®
            getScoreRangeAdvice: (rank, total) => {
                const percentage = (rank / total) * 100;
                const ranges = [
                    { max: 1, label: 'é¡¶å°–', color: 'text-purple-600', icon: 'ğŸ†' },
                    { max: 5, label: 'ä¼˜ç§€', color: 'text-blue-600', icon: 'â­' },
                    { max: 10, label: 'è‰¯å¥½', color: 'text-green-600', icon: 'âœ¨' },
                    { max: 20, label: 'ä¸­ä¸Š', color: 'text-yellow-600', icon: 'ğŸ’ª' },
                    { max: 50, label: 'ä¸­ç­‰', color: 'text-orange-600', icon: 'ğŸ“š' },
                    { max: 100, label: 'ä¸€èˆ¬', color: 'text-gray-600', icon: 'ğŸ’¡' },
                ];
                
                for (const range of ranges) {
                    if (percentage <= range.max) {
                        return range;
                    }
                }
                return ranges[ranges.length - 1];
            }
        };
        
        // APIæœåŠ¡
        class ApiService {
            constructor() {
                this.cache = new Map();
                this.axios = axios.create({
                    baseURL: CONFIG.API_BASE_URL,
                    timeout: 10000,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            }
            
            // æŸ¥è¯¢æ’å
            async queryRank(score, year = null) {
                const cacheKey = `rank_${score}_${year || 'default'}`;
                
                // æ£€æŸ¥ç¼“å­˜
                const cached = this.cache.get(cacheKey);
                if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_TTL) {
                    return cached.data;
                }
                
                try {
                    const response = await this.axios.post('/rank', { score, year });
                    const data = response.data;
                    
                    // ç¼“å­˜ç»“æœ
                    this.cache.set(cacheKey, {
                        data,
                        timestamp: Date.now()
                    });
                    
                    return data;
                } catch (error) {
                    if (error.response) {
                        throw new Error(error.response.data.detail || 'æŸ¥è¯¢å¤±è´¥');
                    } else if (error.request) {
                        throw new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                    } else {
                        throw new Error('è¯·æ±‚å¤±è´¥');
                    }
                }
            }
            
            // è·å–ç»Ÿè®¡ä¿¡æ¯
            async getStatistics(year = null) {
                const cacheKey = `stats_${year || 'default'}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_TTL) {
                    return cached.data;
                }
                
                const response = await this.axios.get('/stats', { params: { year } });
                const data = response.data;
                
                this.cache.set(cacheKey, {
                    data,
                    timestamp: Date.now()
                });
                
                return data;
            }
            
            // æ¸…é™¤ç¼“å­˜
            clearCache() {
                this.cache.clear();
            }
        }
        
        // åˆ›å»ºAPIå®ä¾‹
        const api = new ApiService();
        
        // ç»„ä»¶ï¼šè¾“å…¥æ¡†
        const ScoreInput = ({ value, onChange, onSubmit, disabled }) => {
            const inputRef = useRef(null);
            
            useEffect(() => {
                inputRef.current?.focus();
            }, []);
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !disabled) {
                    onSubmit();
                }
            };
            
            return (
                <div className="relative">
                    <input
                        ref={inputRef}
                        type="text"
                        inputMode="decimal"
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                        onKeyPress={handleKeyPress}
                        disabled={disabled}
                        placeholder="è¯·è¾“å…¥åˆ†æ•°ï¼ˆå¦‚750.25ï¼‰"
                        style={{fontSize: '16px'}}
                        className="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg 
                                 focus:outline-none focus:ring-2 focus:ring-black focus:border-black 
                                 disabled:bg-gray-100 disabled:cursor-not-allowed
                                 transition-all duration-200"
                    />
                    <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span className="text-gray-400 text-sm">åˆ†</span>
                    </div>
                </div>
            );
        };
        
        // ç»„ä»¶ï¼šæŸ¥è¯¢æŒ‰é’®
        const QueryButton = ({ onClick, loading, disabled }) => {
            return (
                <button
                    onClick={onClick}
                    disabled={disabled || loading}
                    className="w-full sm:w-auto px-6 py-2 bg-black text-white rounded-lg 
                             hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 
                             focus:ring-black disabled:bg-gray-400 disabled:cursor-not-allowed 
                             transition-all duration-200 flex items-center justify-center gap-2"
                >
                    {loading ? (
                        <>
                            <div className="loader"></div>
                            <span>æŸ¥è¯¢ä¸­...</span>
                        </>
                    ) : (
                        <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <span>æŸ¥è¯¢ä½æ¬¡</span>
                        </>
                    )}
                </button>
            );
        };
        
        // ç»„ä»¶ï¼šç»“æœå±•ç¤º
        const ResultDisplay = ({ result }) => {
            const advice = utils.getScoreRangeAdvice(result.rank, result.total_students);
            
            return (
                <div className="animate-fadeIn space-y-6">
                    {/* ä¸»è¦ç»“æœ */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold">æŸ¥è¯¢ç»“æœ</h3>
                            <span className={`text-2xl ${advice.color}`}>{advice.icon}</span>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div className="text-center p-4 bg-gray-50 rounded-lg">
                                <div className="text-3xl font-bold text-gray-900">
                                    {utils.formatNumber(result.rank)}
                                </div>
                                <div className="text-sm text-gray-600 mt-1">å…¨å¸‚æ’å</div>
                            </div>
                            
                            <div className="text-center p-4 bg-gray-50 rounded-lg">
                                <div className="text-3xl font-bold text-gray-900">
                                    {result.percentage.toFixed(1)}%
                                </div>
                                <div className="text-sm text-gray-600 mt-1">è¶…è¿‡è€ƒç”Ÿ</div>
                            </div>
                        </div>
                        
                        <div className="mt-4 pt-4 border-t border-gray-100">
                            <div className="flex items-center justify-between text-sm">
                                <span className="text-gray-600">æ€»äººæ•°</span>
                                <span className="font-medium">{utils.formatNumber(result.total_students)}äºº</span>
                            </div>
                            {result.rank_range && (
                                <div className="flex items-center justify-between text-sm mt-2">
                                    <span className="text-gray-600">è¯¥åˆ†æ•°æ’ååŒºé—´</span>
                                    <span className="font-medium">
                                        ç¬¬{utils.formatNumber(result.rank_range.start)}-{utils.formatNumber(result.rank_range.end)}å
                                    </span>
                                </div>
                            )}
                            <div className="flex items-center justify-between text-sm mt-2">
                                <span className="text-gray-600">å½“å‰åˆ†æ•°æ®µäººæ•°</span>
                                <span className="font-medium">{utils.formatNumber(result.segment_count || 0)}äºº</span>
                            </div>
                            <div className="flex items-center justify-between text-sm mt-2">
                                <span className="text-gray-600">æˆç»©æ°´å¹³</span>
                                <span className={`font-medium ${advice.color}`}>{advice.label}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        
        // ä¸»åº”ç”¨ç»„ä»¶
        const App = () => {
            const [score, setScore] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            
            
            // å¤„ç†æŸ¥è¯¢
            const handleQuery = useCallback(async () => {
                const validation = utils.validateScore(score);
                
                if (!validation.valid) {
                    setError(validation.error);
                    return;
                }
                
                setError('');
                setLoading(true);
                setResult(null);
                
                try {
                    const data = await api.queryRank(validation.value);
                    setResult(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, [score]);
            
            // å¤„ç†è¾“å…¥å˜åŒ–
            const handleScoreChange = useCallback((value) => {
                setScore(value);
                setError('');
                
                // å®æ—¶éªŒè¯
                if (value && !utils.validateScore(value).valid) {
                    const debouncedValidation = utils.debounce(() => {
                        const validation = utils.validateScore(value);
                        if (!validation.valid) {
                            setError(validation.error);
                        }
                    }, CONFIG.DEBOUNCE_DELAY);
                    debouncedValidation();
                }
            }, []);
            
            return (
                <div className="min-h-screen bg-gray-50 py-8">
                    <div className="max-w-2xl mx-auto px-4">
                        {/* å¤´éƒ¨ */}
                        <header className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">
                                å¤©æ´¥ä¸­è€ƒä½æ¬¡æŸ¥è¯¢ç³»ç»Ÿ
                            </h1>
                            <p className="text-gray-600">
                                2025å¹´å¤©æ´¥å…¨å¸‚ä¸­è€ƒæˆç»©ä½æ¬¡æŸ¥è¯¢
                            </p>
                        </header>
                        
                        {/* æŸ¥è¯¢è¡¨å• */}
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ä¸­è€ƒåˆ†æ•°
                                    </label>
                                    <ScoreInput
                                        value={score}
                                        onChange={handleScoreChange}
                                        onSubmit={handleQuery}
                                        disabled={loading}
                                    />
                                    {error && (
                                        <p className="mt-2 text-sm text-red-600 flex items-center gap-1">
                                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fillRule="evenodd" 
                                                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" 
                                                      clipRule="evenodd" />
                                            </svg>
                                            {error}
                                        </p>
                                    )}
                                </div>
                                
                                <div className="flex justify-center">
                                    <QueryButton
                                        onClick={handleQuery}
                                        loading={loading}
                                        disabled={!score || !!error}
                                    />
                                </div>
                            </div>
                        </div>
                        
                        {/* æŸ¥è¯¢ç»“æœ */}
                        {result && <ResultDisplay result={result} />}
                        
                        
                        {/* é¡µè„š */}
                        <footer className="text-center text-sm text-gray-500 mt-8">
                            <p>æ•°æ®ä»…ä¾›å‚è€ƒï¼Œå®é™…å½•å–ä»¥å®˜æ–¹å…¬å¸ƒä¸ºå‡†</p>
                        </footer>
                    </div>
                </div>
            );
        };
        
        // æ¸²æŸ“åº”ç”¨
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>